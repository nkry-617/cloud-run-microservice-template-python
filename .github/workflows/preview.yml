name: Deploy Preview to Cloud Run

on:
  pull_request:
    branches:
      - main
    # ã€èª²é¡Œ1ã€‘PRãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸæ™‚ã€ãŠã‚ˆã³é–‰ã˜ã‚‰ã‚ŒãŸæ™‚ã«å‹•ã‹ã™
    types: [opened, synchronize, reopened, closed]

env:
  PROJECT_ID: ex-ai-training-program
  GAR_LOCATION: asia-northeast1
  REPOSITORY: mayuko0213
  SERVICE_BASE: mayuko0213
  REGION: asia-northeast1

jobs:
  # ===================================================
  # Job 1: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤ (Open/Updateæ™‚)
  # ===================================================
  deploy-preview:
    # PRãŒé–‰ã˜ã‚‰ã‚ŒãŸæ™‚ä»¥å¤–ã«å®Ÿè¡Œã™ã‚‹
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
      pull-requests: 'write'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ã€èª²é¡Œ2ã€‘PRç•ªå·ä»˜ãã®ã‚µãƒ¼ãƒ“ã‚¹åã‚’ç”Ÿæˆ
      - name: Set Service Name
        run: echo "SERVICE_NAME=${{ env.SERVICE_BASE }}-pr-${{ github.event.number }}" >> $GITHUB_ENV

      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ vars.WIF_PROVIDER }}'
          project_id: '${{ env.PROJECT_ID }}'

      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: '${{ env.PROJECT_ID }}'

      # ã€èª²é¡Œ3ã€‘Cloud Build ã§ã®ãƒ“ãƒ«ãƒ‰ & Push
      - name: Build and Push via Cloud Build
        run: |
          gcloud builds submit \
            --quiet \
            --tag "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }}" \
            --project "${{ env.PROJECT_ID }}" \
            .

      # ã€èª²é¡Œ4ã€‘Cloud Run ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy to Cloud Run
        id: deploy
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: '${{ env.SERVICE_NAME }}'
          region: '${{ env.REGION }}'
          image: '${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }}'
          flags: '--allow-unauthenticated'

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.deploy.outputs.url }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸš€ **Preview Environment Deployed!**\n\nApp is running at: ${url}\n\n(Latest commit: ${context.sha})`
            })

  # ===================================================
  # Job 2: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã®å‰Šé™¤ (Close/Mergeæ™‚)
  # ===================================================
  cleanup-preview:
    # ã€èª²é¡Œ5ã€‘PRãŒé–‰ã˜ã‚‰ã‚ŒãŸæ™‚ã®ã¿å®Ÿè¡Œ
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
      pull-requests: 'write'

    steps:
      - name: Set Service Name
        run: echo "SERVICE_NAME=${{ env.SERVICE_BASE }}-pr-${{ github.event.number }}" >> $GITHUB_ENV

      - name: Google Auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ vars.WIF_PROVIDER }}'
          project_id: '${{ env.PROJECT_ID }}'

      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: '${{ env.PROJECT_ID }}'

      # ã€èª²é¡Œ6ã€‘Cloud Run ã‚µãƒ¼ãƒ“ã‚¹ã®å‰Šé™¤
      - name: Delete Cloud Run Service
        run: |
          gcloud run services delete ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --project ${{ env.PROJECT_ID }} \
            --quiet

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ—‘ï¸ **Preview Environment Deleted.**\n\nThe Cloud Run service has been cleaned up.`
            })
